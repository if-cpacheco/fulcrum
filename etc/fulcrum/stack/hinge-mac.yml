mariadb:
  container_name: mariadb
  image: fulcrum/mariadb
  volumes:
   - /mnt/fulcrum/etc/mysql:/etc/mysql
   - /mnt/fulcrum/log/mariadb:/var/log
   - /mnt/fulcrum/data/mysql:/var/lib/mysql
   - /mnt/fulcrum/data:/data
  environment:
   - MYSQL_ALLOW_EMPTY_PASSWORD=yes
  ports:
    - "3306:3306"

redis:
  container_name: redis
  image: fulcrum/redis:latest-alpine
  volumes:
    - /mnt/fulcrum/etc/redis/redis.conf:/etc/redis/redis.conf
    - /mnt/fulcrum/log/redis:/var/log
  ports:
    - "6379:6379"

phpfpm:
  container_name: phpfpm
  image: fulcrum/php:latest-alpine
  volumes:
    - /mnt/fulcrum/etc/php5:/etc/php5
    - /mnt/fulcrum/log/php:/var/log
    - /mnt/fulcrum/etc/fulcrum/php:/fulcrum:ro
    - /mnt/fulcrum/files:/drupal_files
    - /mnt/fulcrum/files/priv:/private
    - /mnt/fulcrum/sites:/var/www/html
    - /mnt/repos:/var/repos
  links:
    - redis
    - mariadb
  extra_hosts:
    - "varnish:$FULCRUM_HOST_IP"

nginx:
  container_name: nginx
  image: fulcrum/nginx:latest-alpine
  volumes:
    - /mnt/fulcrum/etc/nginx:/etc/nginx
    - /mnt/fulcrum/log/nginx:/var/log
    - /mnt/fulcrum/files:/drupal_files:ro
    - /mnt/fulcrum/sites:/var/www/html:ro
    - /mnt/repos:/var/repos:ro
  links:
    - phpfpm
  ports:
    - "8080:80"

varnish:
  container_name: varnish
  image: fulcrum/varnish:latest-alpine
  volumes:
    - /mnt/fulcrum/etc/varnish:/etc/varnish
    - /mnt/fulcrum/log/varnish:/var/log
  command: -F -P /var/run/varnish.pid -a :80,PROXY -f /etc/varnish/default.vcl -S /etc/varnish/secret -T 0.0.0.0:6082 -t 120 -s malloc,128M
  links:
    - nginx
  ports:
    - "6081:80"
    - "6082:6082"

haproxy:
  container_name: haproxy
  image: fulcrum/haproxy:latest-1.6-alpine
  volumes:
    - /mnt/fulcrum/etc/haproxy:/etc/haproxy
    - /mnt/fulcrum/etc/haproxy/haproxy-1.6.cfg:/etc/haproxy/haproxy.cfg
    - /mnt/fulcrum/etc/certs.d:/etc/certs.d
    - /mnt/fulcrum/log/haproxy:/var/log
  links:
    - varnish
  ports:
    - "80:80"
    - "443:443"
    - "1936:1936"

drush:
  container_name: drush
  image: fulcrum/drush:latest-alpine
  tty: true
  volumes:
    - /mnt/fulcrum/etc/php5:/etc/php5:ro
    - /mnt/fulcrum/log/drush:/var/log
    - /mnt/fulcrum/files:/drupal_files
    - /mnt/fulcrum/files/priv:/private
    - /mnt/fulcrum/sites:/var/www/html
    - /mnt/fulcrum/etc/fulcrum/php:/var/www/html/fulcrum/php:ro
    - /mnt/repos:/var/repos
  entrypoint: /bin/sh
  links:
    - redis
    - mariadb
    - varnish

# needed for rails, but only local dev
# solr:
#   container_name: solr
#   image: solr:5.4.1-alpine
#   links:
#     - phpfpm
#   ports:
#     - "8983:8983"
#   volumes:
#     - /mnt/fulcrum/log/solr:/opt/solr/server/logs
#     - /mnt/fulcrum/etc/solr:/opt/solr/server/etc
#     - /mnt/fulcrum/data/solr:/opt/solr/server/solr
