#!/bin/bash

set -e

. ~/fulcrum/bin/fulcrum-env

TAG=centos7-php5.6-remi-drush
SITE=$1
MARIABDB_LINK=""
MARIABDB_ENV=""
REDIS_LINK=""
NOW=$($FULCRUM_PATH/bin/now)
FULCRUM_DOCKER_PREFIX=""
FULCRUM_DOCKER_SUFIX=""
DOCKER_PS_CMD="${FULCRUM_DOCKER_PREFIX}docker ps$FULCRUM_DOCKER_SUFIX"
DOCKER_PS=$(eval "$DOCKER_PS_CMD")

if [[ "$DOCKER_PS" == *"mariadb"* ]]; then
  MARIABDB_LINK="--link mariadb:mariadb"
  MARIABDB_ENV="--env=FULCRUM_DB=mariadb"
fi

if [[ "$DOCKER_PS" == *"redis"* ]]; then
  REDIS_LINK="--link redis:redis"
fi

CONF="$FULCRUM_PATH/conf/$SITE.json"

if [ ! -f $CONF ]; then
    echo "Cannot find configuration file for domain: $CONF"
    exit 1
fi

# remove domain from remaining arguments
shift
REST=$@

mkdir -p $FULCRUM_PATH/log/$TAG/php-fpm

PULL="${FULCRUM_DOCKER_PREFIX}docker pull fulcrum/$TAG$FULCRUM_DOCKER_SUFIX"
# echo $PULL
eval "$PULL > /dev/null 2>&1"

RUN="$FULCRUM_DOCKER_PREFIX                           \
docker run                                            \
    --name=drush-$NOW                                 \
    --detach=false --interactive=true --tty=true --rm \
    $MARIABDB_LINK                                    \
    $REDIS_LINK                                       \
    --volume=/mnt/fulcrum/etc/php.ini:/etc/php.ini    \
    --volume=/mnt/fulcrum/log/$TAG:/var/log           \
    --volume=/mnt/fulcrum/files:/drupal_files         \
    --volume=/mnt/fulcrum/webroots:/var/www/html      \
    --volume=/mnt/fulcrum/php:/fulcrum:ro             \
    --volume=/mnt/repos:/var/repos                    \
    --volume=/mnt/fulcrum/conf/$SITE.json:/config.json:ro \
    --workdir=/var/www/html/$SITE/                    \
    --entrypoint=/root/.composer/vendor/bin/drush     \
    $MARIABDB_ENV                                     \
    fulcrum/$TAG                                      \
    --uri=http://$SITE $@$FULCRUM_DOCKER_SUFIX"

eval "$RUN"
