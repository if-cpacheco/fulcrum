#!/bin/bash
# set -x

FULCRUM_BINDIR="$(cd "$(dirname "${BASH_SOURCE[0]}")"&&pwd)"
source ${FULCRUM_BINDIR}/lib/general

vout "Running doctor"

requireSudo

HINGECONFIGREPO=""
if [ -e /tmp/HINGECONFIGREPO ]; then
  HINGECONFIGREPO=$(cat /tmp/HINGECONFIGREPO)
  touch /tmp/HINGEUSEDEFAULTS
fi

# allow for override in a custom doctor file
if [[ "$HINGECONFIGREPO" == "" && ! -e ${FULCRUM_DIRNAME}/var/fulcrum/hinge-config ]]; then
  # checkout sites repo
  HINGECONFIGREPODEFAULT=https://github.com/if-fulcrum/hinge-config.git

  # TODO: this is breaking from running
  read -p "Please enter Fulcrum Hinge Config repo URL (default: $HINGECONFIGREPODEFAULT): " HINGECONFIGREPO

  if [ "$HINGECONFIGREPO" == "" ]; then
    HINGECONFIGREPO=$HINGECONFIGREPODEFAULT
  fi
fi

etcHosts 127.0.0.1 mariadb
etcHosts 127.0.0.1 redis
etcHosts 127.0.0.1 varnish
etcHosts 127.0.0.1 certbot

if [ ! -e $FULCRUM_DIRNAME/etc/varnish/internal.vcl ]; then
  echo 'acl internal  { "0.0.0.0"/0;  }' > $FULCRUM_DIRNAME/etc/varnish/internal.vcl
fi

if [ ! -e $FULCRUM_DIRNAME/etc/varnish/whitelist.vcl ]; then
  echo 'acl whitelist { "0.0.0.0"/0;  }' > $FULCRUM_DIRNAME/etc/varnish/whitelist.vcl
fi

if [ ! -e $FULCRUM_DIRNAME/etc/varnish/blacklist.vcl ]; then
  echo 'acl blacklist { "0.0.0.0"/32; }' > $FULCRUM_DIRNAME/etc/varnish/blacklist.vcl
fi

# make a minimal fulcrum_config.conf
if [ ! -e $FULCRUM_DIRNAME/etc/nginx/fulcrum/fulcrum_config.conf ]; then
  cp $FULCRUM_DIRNAME/etc/fulcrum/nginx-fulcrum_config-blank.conf $FULCRUM_DIRNAME/etc/nginx/fulcrum/fulcrum_config.conf
fi
if [ ! -e $FULCRUM_DIRNAME/etc/nginx-xdebug/fulcrum/fulcrum_config.conf ]; then
  cp $FULCRUM_DIRNAME/etc/fulcrum/nginx-fulcrum_config-blank.conf $FULCRUM_DIRNAME/etc/nginx-xdebug/fulcrum/fulcrum_config.conf
fi

# make a minimal fulcrum_phpversion.conf
if [ ! -e $FULCRUM_DIRNAME/etc/nginx/fulcrum/fulcrum_phpversion.conf ]; then
  cp $FULCRUM_DIRNAME/etc/fulcrum/nginx-fulcrum_phpversion-blank.conf $FULCRUM_DIRNAME/etc/nginx/fulcrum/fulcrum_phpversion.conf
fi
if [ ! -e $FULCRUM_DIRNAME/etc/nginx-xdebug/fulcrum/fulcrum_phpversion.conf ]; then
  cp $FULCRUM_DIRNAME/etc/fulcrum/nginx-fulcrum_phpversion-blank.conf $FULCRUM_DIRNAME/etc/nginx-xdebug/fulcrum/fulcrum_phpversion.conf
fi

# copy blackfire template
if [ ! -e $FULCRUM_DIRNAME/etc/fulcrum/stack/env/blackfire.env ]; then
  cp $FULCRUM_DIRNAME/etc/fulcrum/stack/env/blackfire.env-template $FULCRUM_DIRNAME/etc/fulcrum/stack/env/blackfire.env
fi

# make mysql directory
if [ ! -d $FULCRUM_DIRNAME/var/lib/mysql ]; then
  mkdir $FULCRUM_DIRNAME/var/lib/mysql
fi

# set mysql perms
sudo chown -R 999:999 $FULCRUM_DIRNAME/var/lib/mysql
sudo chmod -R u+w,u+r $FULCRUM_DIRNAME/var/lib/mysql

# make elasticsearch directory
if [ ! -d $FULCRUM_DIRNAME/var/lib/elasticsearch ]; then
  sudo mkdir $FULCRUM_DIRNAME/var/lib/elasticsearch
fi

# set elasticsearch perms
sudo chown -R 1000:0 $FULCRUM_DIRNAME/var/lib/elasticsearch
sudo chmod -R 770 $FULCRUM_DIRNAME/var/lib/elasticsearch

source $FULCRUM_DIRNAME/bin/lib/cli-autocomplete

# run OS doctor
if [ -e ${FULCRUM_BINDIR}/lib/doctor-$FULCRUM_OS_LC ]; then
  source ${FULCRUM_BINDIR}/lib/doctor-$FULCRUM_OS_LC

  # run distro doctor
  if [ -n "$FULCRUM_OS_DISTRO" ]; then
    if [ -e ${FULCRUM_BINDIR}/lib/doctor-$FULCRUM_OS_DISTRO ]; then
      source ${FULCRUM_BINDIR}/lib/doctor-$FULCRUM_OS_DISTRO
    else
      eout "No distro doctor file to run, Fulcrum Hinge probably needs to be extended for $FULCRUM_OS_DISTRO"
    fi
  fi
else
  eout "No OS doctor file to run, Fulcrum Hinge probably needs to be extended for $FULCRUM_OS_LC"
fi

# set the resolver IP for nginx
echo "resolver $FULCRUM_HOST_IP valid=300s;" > $FULCRUM_DIRNAME/var/fulcrum/nginx/resolver.conf

# secret needs to be made *after* docker has been installed
varnishSecret > /dev/null

# clonge out the fulcrum hinge config repo
if [ ! -e ${FULCRUM_DIRNAME}/var/fulcrum/hinge-config ]; then
  git -C ${FULCRUM_DIRNAME}/var/fulcrum clone $HINGECONFIGREPO hinge-config
fi

# run the custom doctor if it exists
if [ -e ${FULCRUM_DIRNAME}/var/fulcrum/hinge-config/bin/lib/doctor-custom ]; then
  source ${FULCRUM_DIRNAME}/var/fulcrum/hinge-config/bin/lib/doctor-custom
fi

# clean up config
if [ -e /tmp/HINGECONFIGREPO ]; then
  rm /tmp/HINGECONFIGREPO
fi

# clean up defaults
if [ -e /tmp/HINGEUSEDEFAULTS ]; then
  rm /tmp/HINGEUSEDEFAULTS
fi

