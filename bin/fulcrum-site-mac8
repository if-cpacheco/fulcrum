#!/bin/bash

# exit script if anything returns an error
set -e

vout()
{
  echo "$1"
}
eout()
{
  vout "$1"
  vout "You might want to run bootstrap again if things are not working"
  exit 1
}

# TODO: make envsubst linked up stream
if [ -d /usr/local/Cellar/gettext/0.19.8.1/bin ]; then
  ENVSUBST=/usr/local/Cellar/gettext/0.19.8.1/bin/envsubst
elif [ -d /usr/local/Cellar/gettext/0.19.7/bin ]; then
  ENVSUBST=/usr/local/Cellar/gettext/0.19.7/bin/envsubst
else
  eout "UNABLE TO FIND bin/envsubst"
fi

CLONING_SITE=false

if [[ "$1" = "--clone" ]]; then
  CLONING_SITE=true
  ORIGINAL_SITE=$2

  FULCRUM_SITE=$3
  FULCRUM_DBNAME=$4
  FULCRUM_REPO=$5
  FULCRUM_AWSPROFILE=$6
else
  ORIGINAL_SITE=$1

  FULCRUM_SITE=$1
  FULCRUM_DBNAME=$2
  FULCRUM_REPO=$3
  FULCRUM_AWSPROFILE=$4
fi

if [ -z $FULCRUM_SITE ];
then
    eout "Error, FULCRUM_SITE not provided!"
else
    vout "FULCRUM_SITE: $FULCRUM_SITE"
fi

if [ -z $FULCRUM_DBNAME ];
then
    eout "Error, FULCRUM_DBNAME not provided!"
else
    vout "FULCRUM_DBNAME: $FULCRUM_DBNAME"
fi

if [ -z $FULCRUM_REPO ];
then
    eout "Error, FULCRUM_REPO not provided!"
else
    vout "FULCRUM_REPO: $FULCRUM_REPO"
fi

if [ ! -z $FULCRUM_AWSPROFILE ];
then
    FULCRUM_AWSPROFILE="--profile $FULCRUM_AWSPROFILE"
fi

FULCRUM_DBBAK=/Users/$USER/fulcrum/bak/$FULCRUM_SITE.sql.gz
FULCRUM_DBPASS=RS1NVShiDo7iID41v4RApgt2gMpfLHZ
FULCRUM_LOCAL=$(echo $FULCRUM_SITE|sed 's;[^.]*$;ifdev;')
FULCRUM_CONF=/Users/$USER/fulcrum/conf/$FULCRUM_SITE.json

# pull down the latest DB
# TODO can we md5sum and see if the latest one is already downloaded
if [ ! -f ~/fulcrum/bak/$FULCRUM_SITE.sql.gz ]; then
  vout "Grabbing $ORIGINAL_SITE latest DB (s3://if-backup/dbs/$ORIGINAL_SITE/latest.sql.gz) saving as ~/fulcrum/bak/$FULCRUM_SITE.sql.gz"
  aws $FULCRUM_AWSPROFILE s3 cp s3://if-backup/dbs/$ORIGINAL_SITE/latest.sql.gz $FULCRUM_DBBAK
else
  vout "skipping download of database as you already have ~/fulcrum/bak/$FULCRUM_SITE.sql.gz"
fi

# for whatever reason, mysql doesn't always make this dir
if [ ! -d /usr/local/etc/my.cnf.d ]; then
  mkdir /usr/local/etc/my.cnf.d
fi

# if DB already exists, ask user if they want to blow it away and restore from latest
DO_RESTORE=true
DB_COUNT=`mysql -s -h 127.0.0.1 -u root --password="" --execute="SHOW DATABASES LIKE '$FULCRUM_DBNAME'" | wc -l`
if [ "$DB_COUNT" -gt 0 ]; then
  read -e -p "Drop existing database and restore from fresh backup? (y/n)" DROPDB
  if [ "$DROPDB" == "y" ]; then
    vout "DROPPING $FULCRUM_DBNAME"
    mysql -h 127.0.0.1 -u root --password="" --execute="DROP DATABASE $FULCRUM_DBNAME"
  else
    vout "skipping DB replacement"
    DO_RESTORE=false
  fi
fi

# create the database
vout "Creating $FULCRUM_DBNAME if not exists"
mysql -h 127.0.0.1 -u root --password="" --execute="CREATE DATABASE IF NOT EXISTS $FULCRUM_DBNAME"

if [ $DO_RESTORE == true ]; then
  vout "Restoring $FULCRUM_DBNAME from $FULCRUM_DBBAK"
  gzcat "$FULCRUM_DBBAK" | mysql -h 127.0.0.1 -u root --password="" $FULCRUM_DBNAME
fi

# get the repo
if [ -d ~/repos/$FULCRUM_LOCAL ]; then
  vout "you appear to already have the repo... skipping clone down"
else
  vout "Cloning repo $FULCRUM_REPO to ~/repos/$FULCRUM_LOCAL"
  git clone $FULCRUM_REPO ~/repos/$FULCRUM_LOCAL

  if [ "$CLONING_SITE" = true ]; then
    vout "Removing original $FULCRUM_REPO .git directory from ~/repos/$FULCRUM_LOCAL"
    rm -rf ~/repos/$FULCRUM_LOCAL/.git
  fi
fi

# link to the webroot
# TODO: for repos that don't use the top level we need to tweak
if [ ! -L ~/fulcrum/webroots/$FULCRUM_LOCAL ]; then
  vout "Symlinking ~/fulcrum/webroots/$FULCRUM_LOCAL -> ../../repos/$FULCRUM_LOCAL/docroot"
  rm -f ~/fulcrum/webroots/$FULCRUM_LOCAL
  ln -s ../../repos/$FULCRUM_LOCAL/docroot ~/fulcrum/webroots/$FULCRUM_LOCAL
fi

# make local files dir
if [ ! -d ~/fulcrum/files/$FULCRUM_LOCAL ]; then
  vout "Making file directory ~/fulcrum/files/$FULCRUM_LOCAL"
  mkdir -p ~/fulcrum/files/$FULCRUM_LOCAL
  chmod -R 777 ~/fulcrum/files/$FULCRUM_LOCAL # don't like that this is 777, but you have trouble with uploads otherwise
fi

# link to the files
if [ ! -L ~/repos/$FULCRUM_LOCAL/docroot/sites/default/files ]; then
  vout "Symlinking ~/repos/$FULCRUM_LOCAL/docroot/sites/default/files -> /drupal_files/$FULCRUM_LOCAL"
  rm -f ~/repos/$FULCRUM_LOCAL/docroot/sites/default/files
  ln -s /drupal_files/$FULCRUM_LOCAL ~/repos/$FULCRUM_LOCAL/docroot/sites/default/files
fi



# TODO: make symlink for wildcards
# ask if a wildcard should be created
#read -p "Respond to any subdomain of *.$MAINSITE (y/n)? " SUBDOMAINS

#if [ "y" == "$SUBDOMAINS" ];
#then
#	echo "Creating symlink for all subdomains *.$MAINSITE.json"
	# cd ~/fulcrum/conf && ln -s $FULCRUM_SITE.json \*.$MAINSITE.json && cd -
#fi

# test to see if the conf exists yet or not
# brew install gettext -- now in bootstrap-fulcrum run
if [ ! -f $FULCRUM_CONF ]; then
  export FULCRUM_DBPASS
  export FULCRUM_DBNAME
  export FULCRUM_ENVIRONMENT=dev
  export FULCRUM_DBUSER=fulcrum
  export FULCRUM_WEBROOT=$FULCRUM_LOCAL
  export FULCRUM_SALT=$(cat /dev/urandom | LC_CTYPE=C tr -dc '_a-zA-Z0-9-' | fold -w 74 | head -n 1)
  export FULCRUM_D8CONFIG="../config/sync"
  # export FULCRUM_COOKIE=.$(echo $FULCRUM_LOCAL|sed 's;^www\.;;g')

  # REDIS=""
  # VARNISH=""

  if [ -d ~/repos/$FULCRUM_LOCAL/docroot/sites/all/modules/contrib/redis ]; then
    REDIS="-redis"
  fi

  if [ -d ~/repos/$FULCRUM_LOCAL/docroot/sites/all/modules/contrib/varnish ]; then
    VARNISH="-varnish"
  fi

  $ENVSUBST<~/fulcrum/conf/json${REDIS}${VARNISH}8.tpl>~/fulcrum/conf/$FULCRUM_LOCAL.json

  ~/fulcrum/bin/fulcrum-node

  docker exec nginx kill -HUP 1
fi

# ensure fulcrum user is in mysql
vout "ensuring fulcrum user exists in mysql"
USER_COUNT=`mysql -s -h 127.0.0.1 -u root --password="" --execute="select * from mysql.User where user = '$FULCRUM_DBUSER' and Host = '172.17.%';" | wc -l`
if [ "$USER_COUNT" -eq 0 ]; then
  mysql -u root -h 127.0.0.1 -e "GRANT SELECT, INSERT, UPDATE, DELETE, CREATE, DROP, INDEX, ALTER, CREATE TEMPORARY TABLES, LOCK TABLES ON *.* TO 'fulcrum'@'172.17.%' IDENTIFIED BY 'RS1NVShiDo7iID41v4RApgt2gMpfLHZ'; FLUSH PRIVILEGES"
fi

cd ~/fulcrum/webroots/$FULCRUM_LOCAL

# set public directory
# vout "running drush set file_public_path..."
# ~/fulcrum/bin/drush $FULCRUM_LOCAL vset file_public_path sites/default/files

# set temporary directory
# vout "running drush set file_temporary_path..."
# ~/fulcrum/bin/drush $FULCRUM_LOCAL vset file_temporary_path /tmp

# clear all caches
vout "running drush cc all..."
/usr/local/bin/drush cr

# open site, logged in as admin
vout "launching site in browser..."
/usr/local/bin/drush uli --uri=http://${FULCRUM_LOCAL}
